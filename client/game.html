<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NMB Game - Playable Prototype</title>
    <script src="https://cdn.socket.io/4.7.1/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0f23, #1a1a3a, #2d1b69);
            color: #e2e8f0;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }
        
        /* Add subtle animated background pattern */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 80%, rgba(120, 219, 255, 0.1) 0%, transparent 50%);
            z-index: -1;
            animation: backgroundShift 20s ease-in-out infinite;
        }
        
        @keyframes backgroundShift {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        .game-container {
            display: flex;
            height: 100vh;
            gap: 20px;
            padding: 20px;
            min-width: 1200px;
            position: relative;
            overflow: hidden; /* Prevent any child content from breaking container */
            box-sizing: border-box;
        }
        
        /* Responsive Design */
        @media (max-width: 1400px) {
            .game-container {
                gap: 15px;
                padding: 15px;
            }
            
            .left-panel {
                flex: 0 0 280px;
            }
            
            .right-panel {
                flex: 0 0 320px;
                max-width: 320px;
            }
        }
        
        @media (max-width: 1200px) {
            .game-container {
                flex-direction: column;
                height: auto;
                min-height: 100vh;
            }
            
            .left-panel, .right-panel {
                flex: none;
                width: 100%;
            }
            
            .center-panel {
                order: 1;
            }
            
            .left-panel {
                order: 2;
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            }
            
            .right-panel {
                order: 3;
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            }
        }
        
        .left-panel {
            flex: 0 0 300px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .center-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .right-panel {
            flex: 0 0 350px;
            max-width: 350px;
            min-width: 300px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow: hidden;
        }
        
        .panel {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            position: relative;
            min-width: 0; /* Allow flex items to shrink below their content size */
            overflow: hidden; /* Prevent content from overflowing the panel */
        }
        
        .panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, 
                rgba(120, 119, 198, 0.1) 0%, 
                transparent 50%, 
                rgba(255, 119, 198, 0.05) 100%);
            border-radius: inherit;
            z-index: -1;
        }
        
        .panel:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 12px 40px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }
        
        .panel h3 {
            color: #4fd1c7;
            margin-bottom: 10px;
            font-size: 1.1em;
            border-bottom: 1px solid rgba(79, 209, 199, 0.3);
            padding-bottom: 5px;
        }
        
        /* Connection Status */
        .connection-status {
            padding: 12px 20px;
            text-align: center;
            border-radius: 25px;
            font-weight: bold;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .connection-status::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 10px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            transform: translateY(-50%);
        }
        
        .connected {
            background: 
                linear-gradient(135deg, rgba(16, 185, 129, 0.3), rgba(5, 150, 105, 0.2));
            border: 1px solid #10b981;
            color: #6ee7b7;
            box-shadow: 
                0 4px 12px rgba(16, 185, 129, 0.2),
                inset 0 1px 2px rgba(255, 255, 255, 0.1);
        }
        
        .connected::before {
            background: #10b981;
            animation: connectedPulse 2s ease-in-out infinite;
        }
        
        .disconnected {
            background: 
                linear-gradient(135deg, rgba(239, 68, 68, 0.3), rgba(220, 38, 38, 0.2));
            border: 1px solid #ef4444;
            color: #fca5a5;
            box-shadow: 
                0 4px 12px rgba(239, 68, 68, 0.2),
                inset 0 1px 2px rgba(255, 255, 255, 0.1);
        }
        
        .disconnected::before {
            background: #ef4444;
            animation: disconnectedBlink 1s ease-in-out infinite;
        }
        
        @keyframes connectedPulse {
            0%, 100% { opacity: 1; transform: translateY(-50%) scale(1); }
            50% { opacity: 0.6; transform: translateY(-50%) scale(0.8); }
        }
        
        @keyframes disconnectedBlink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        /* Game Controls */
        .game-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .input-group label {
            font-size: 0.9em;
            color: #cccccc;
        }
        
        /* Input and Button Base Styling */
        input, button {
            padding: 12px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
        }
        
        input {
            background: 
                linear-gradient(135deg, rgba(255, 255, 255, 0.12), rgba(255, 255, 255, 0.08));
            color: #ffffff;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 
                inset 0 2px 4px rgba(0, 0, 0, 0.2),
                0 2px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        input::placeholder {
            color: #94a3b8;
        }
        
        input:focus {
            outline: none;
            border-color: #4fd1c7;
            background: 
                linear-gradient(135deg, rgba(79, 209, 199, 0.15), rgba(79, 209, 199, 0.08));
            box-shadow: 
                inset 0 2px 4px rgba(0, 0, 0, 0.2),
                0 0 12px rgba(79, 209, 199, 0.3),
                0 2px 6px rgba(0, 0, 0, 0.1);
        }
        
        button {
            background: linear-gradient(135deg, #4fd1c7, #29b6f6);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 
                0 4px 12px rgba(79, 209, 199, 0.3),
                inset 0 1px 2px rgba(255, 255, 255, 0.1);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }
        
        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.6s ease;
        }
        
        button:hover::before {
            left: 100%;
        }
        
        button:hover {
            transform: translateY(-3px);
            box-shadow: 
                0 8px 20px rgba(79, 209, 199, 0.4),
                inset 0 1px 2px rgba(255, 255, 255, 0.2);
        }
        
        button:active {
            transform: translateY(-1px);
        }
        
        button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* Player Status */
        .player-status {
            border: 2px solid rgba(79, 209, 199, 0.6);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 
                0 8px 24px rgba(0, 0, 0, 0.3),
                inset 0 1px 2px rgba(255, 255, 255, 0.1);
        }
        
        .player-header {
            background: linear-gradient(135deg, #4fd1c7, #29b6f6);
            padding: 15px;
            font-weight: bold;
            font-size: 16px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
            position: relative;
        }
        
        .player-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        }
        
        .player-stats {
            padding: 15px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            font-size: 0.9em;
            background: 
                linear-gradient(135deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.02));
        }
        
        .stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: 
                linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 
                0 2px 6px rgba(0, 0, 0, 0.2),
                inset 0 1px 1px rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        
        .stat:hover {
            background: 
                linear-gradient(135deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.08));
            transform: translateY(-1px);
        }
        
        .stat span:first-child {
            color: #cbd5e1;
            font-weight: 500;
        }
        
        .stat span:last-child {
            color: #ffffff;
            font-weight: bold;
            font-family: 'Courier New', monospace;
        }
        
        .disorder-high {
            background: 
                linear-gradient(135deg, rgba(239, 68, 68, 0.3), rgba(220, 38, 38, 0.2)) !important;
            border: 1px solid #ef4444 !important;
            box-shadow: 
                0 0 12px rgba(239, 68, 68, 0.4),
                inset 0 1px 1px rgba(255, 255, 255, 0.1) !important;
            animation: dangerPulse 2s ease-in-out infinite;
        }
        
        .disorder-high span:last-child {
            color: #fca5a5 !important;
        }
        
        @keyframes dangerPulse {
            0%, 100% { 
                border-color: #ef4444;
                box-shadow: 
                    0 0 12px rgba(239, 68, 68, 0.4),
                    inset 0 1px 1px rgba(255, 255, 255, 0.1);
            }
            50% { 
                border-color: #dc2626;
                box-shadow: 
                    0 0 20px rgba(239, 68, 68, 0.6),
                    inset 0 1px 1px rgba(255, 255, 255, 0.2);
            }
        }
        
        /* Game Board */
        .game-board {
            background: 
                linear-gradient(135deg, rgba(0, 0, 0, 0.4), rgba(20, 20, 60, 0.3)),
                radial-gradient(circle at center, rgba(79, 209, 199, 0.1) 0%, transparent 70%);
            border-radius: 15px;
            min-height: 500px;
            padding: 30px;
            position: relative;
            overflow: auto;
            border: 2px solid rgba(79, 209, 199, 0.3);
            box-shadow: 
                0 10px 30px rgba(0, 0, 0, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }
        
        .board-message {
            text-align: center;
            color: #94a3b8;
            margin-top: 150px;
            font-size: 1.2em;
            font-weight: 500;
        }
        
        /* Floor Indicator */
        .floor-indicator {
            text-align: center;
            margin-bottom: 20px;
            padding: 10px 20px;
            background: 
                linear-gradient(135deg, rgba(79, 209, 199, 0.2), rgba(41, 182, 246, 0.1));
            border-radius: 25px;
            border: 1px solid rgba(79, 209, 199, 0.4);
            display: inline-block;
            font-weight: bold;
            font-size: 14px;
            box-shadow: 
                0 4px 12px rgba(0, 0, 0, 0.2),
                inset 0 1px 2px rgba(255, 255, 255, 0.1);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }
        
        .floor-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .floor-btn {
            padding: 8px 12px;
            background: 
                linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: #cbd5e1;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            min-width: 40px;
        }
        
        .floor-btn:hover {
            background: 
                linear-gradient(135deg, rgba(79, 209, 199, 0.2), rgba(79, 209, 199, 0.1));
            border-color: #4fd1c7;
            color: #ffffff;
            transform: translateY(-1px);
        }
        
        .floor-btn.active {
            background: linear-gradient(135deg, #4fd1c7, #29b6f6);
            border-color: #4fd1c7;
            color: #ffffff;
            box-shadow: 
                0 4px 12px rgba(79, 209, 199, 0.4),
                inset 0 1px 2px rgba(255, 255, 255, 0.2);
        }
        
        /* Board Controls */
        .board-controls {
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
        }
        
        .game-info {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .info-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: 
                linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            font-size: 12px;
            box-shadow: 
                0 2px 6px rgba(0, 0, 0, 0.2),
                inset 0 1px 1px rgba(255, 255, 255, 0.1);
        }
        
        .info-label {
            color: #94a3b8;
            font-weight: 500;
        }
        
        .info-value {
            color: #4fd1c7;
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }
        
        .board-grid {
            display: grid;
            grid-template-columns: repeat(16, 24px);
            grid-template-rows: repeat(16, 24px);
            gap: 2px;
            margin: 20px auto;
            justify-content: center;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid rgba(79, 209, 199, 0.2);
        }
        
        .board-tile {
            width: 24px;
            height: 24px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 4px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
        }
        
        .tile-boundary {
            border: 2px solid rgba(255, 255, 255, 0.4) !important;
        }
        
        .board-tile:hover {
            border-color: #4fd1c7;
            transform: scale(1.1);
        }
        
        .tile-basic {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            box-shadow: inset 0 1px 2px rgba(255, 255, 255, 0.2);
        }
        
        .tile-basic::before {
            content: '○';
            color: rgba(255, 255, 255, 0.7);
        }
        
        .tile-disordered {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            box-shadow: 
                inset 0 1px 2px rgba(255, 255, 255, 0.2),
                0 0 8px rgba(239, 68, 68, 0.4);
            animation: pulseDisorder 2s ease-in-out infinite;
        }
        
        .tile-disordered::before {
            content: '⚠';
            color: #fff;
            animation: shake 1s ease-in-out infinite;
        }
        
        .tile-stairwell {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            box-shadow: inset 0 1px 2px rgba(255, 255, 255, 0.2);
        }
        
        .tile-stairwell::before {
            content: '▲';
            color: #fff;
        }
        
        .tile-elevator {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            box-shadow: inset 0 1px 2px rgba(255, 255, 255, 0.2);
        }
        
        .tile-elevator::before {
            content: '⬍';
            color: #fff;
        }
        
        .tile-initial {
            background: linear-gradient(135deg, #10b981, #059669);
            border: 2px solid rgba(255, 255, 255, 0.8);
            box-shadow: 
                inset 0 1px 2px rgba(255, 255, 255, 0.3),
                0 0 12px rgba(16, 185, 129, 0.6);
        }
        
        .tile-initial::before {
            content: '◊';
            color: #fff;
        }
        
        .tile-corrupted {
            background: 
                linear-gradient(45deg, #000, #220000) !important;
            border: 1px solid #8B0000 !important;
            box-shadow: 
                inset 0 0 8px rgba(139, 0, 0, 0.8),
                0 0 15px rgba(139, 0, 0, 0.5) !important;
            animation: corruptedPulse 3s ease-in-out infinite;
        }
        
        .tile-corrupted::before {
            content: '✖';
            color: #8B0000;
        }
        
        .tile-wall {
            background: 
                linear-gradient(135deg, #374151, #4b5563) !important;
            border: 1px solid #6b7280 !important;
            cursor: not-allowed;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .tile-wall::before {
            content: '■';
            color: #9ca3af;
        }
        
        @keyframes pulseDisorder {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-1px); }
            75% { transform: translateX(1px); }
        }
        
        @keyframes corruptedPulse {
            0%, 100% { 
                box-shadow: 
                    inset 0 0 8px rgba(139, 0, 0, 0.8),
                    0 0 15px rgba(139, 0, 0, 0.5);
            }
            50% { 
                box-shadow: 
                    inset 0 0 12px rgba(139, 0, 0, 1),
                    0 0 25px rgba(139, 0, 0, 0.8);
            }
        }
        
        .player-pawn {
            position: absolute;
            top: 2px;
            left: 2px;
            right: 2px;
            bottom: 2px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.9);
            font-size: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #fff;
            z-index: 10;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
            box-shadow: 
                0 2px 8px rgba(0, 0, 0, 0.6),
                inset 0 1px 2px rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }
        
        .player-pawn:hover {
            transform: scale(1.2);
            box-shadow: 
                0 4px 12px rgba(0, 0, 0, 0.8),
                inset 0 1px 2px rgba(255, 255, 255, 0.4);
        }
        
        .player-1 { 
            background: linear-gradient(135deg, #ef4444, #dc2626);
            border-color: #fca5a5;
        }
        .player-1::before { content: '①'; }
        
        .player-2 { 
            background: linear-gradient(135deg, #06b6d4, #0891b2);
            border-color: #67e8f9;
        }
        .player-2::before { content: '②'; }
        
        .player-3 { 
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            border-color: #93c5fd;
        }
        .player-3::before { content: '③'; }
        
        .player-4 { 
            background: linear-gradient(135deg, #eab308, #ca8a04);
            border-color: #fde047;
        }
        .player-4::before { content: '④'; }
        
        /* Action Buttons */
        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .action-btn {
            padding: 12px 16px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 
                0 4px 12px rgba(102, 126, 234, 0.2),
                inset 0 1px 2px rgba(255, 255, 255, 0.1);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }
        
        .action-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.6s ease;
        }
        
        .action-btn:hover::before {
            left: 100%;
        }
        
        .action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 
                0 8px 20px rgba(102, 126, 234, 0.4),
                inset 0 1px 2px rgba(255, 255, 255, 0.2);
        }
        
        .action-btn:active {
            transform: translateY(-1px);
            box-shadow: 
                0 2px 8px rgba(102, 126, 234, 0.3),
                inset 0 1px 2px rgba(0, 0, 0, 0.2);
        }
        
        .action-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .action-btn.primary {
            background: linear-gradient(135deg, #4fd1c7, #29b6f6);
            box-shadow: 
                0 4px 12px rgba(79, 209, 199, 0.3),
                inset 0 1px 2px rgba(255, 255, 255, 0.1);
        }
        
        .action-btn.primary:hover {
            box-shadow: 
                0 8px 20px rgba(79, 209, 199, 0.5),
                inset 0 1px 2px rgba(255, 255, 255, 0.2);
        }
        
        .action-btn.danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            box-shadow: 
                0 4px 12px rgba(239, 68, 68, 0.3),
                inset 0 1px 2px rgba(255, 255, 255, 0.1);
        }
        
        .action-btn.danger:hover {
            box-shadow: 
                0 8px 20px rgba(239, 68, 68, 0.5),
                inset 0 1px 2px rgba(255, 255, 255, 0.2);
        }
        
        /* Player Hand */
        .player-hand {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .card {
            background: 
                linear-gradient(135deg, rgba(255, 255, 255, 0.12), rgba(255, 255, 255, 0.06));
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 12px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 
                0 4px 12px rgba(0, 0, 0, 0.2),
                inset 0 1px 2px rgba(255, 255, 255, 0.1);
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #4fd1c7, #29b6f6);
            border-radius: 10px 10px 0 0;
        }
        
        .card:hover {
            border-color: #4fd1c7;
            background: 
                linear-gradient(135deg, rgba(79, 209, 199, 0.15), rgba(79, 209, 199, 0.08));
            transform: translateY(-2px);
            box-shadow: 
                0 8px 20px rgba(0, 0, 0, 0.3),
                inset 0 1px 2px rgba(255, 255, 255, 0.2);
        }
        
        .card-name {
            font-weight: bold;
            color: #ffffff;
            margin-bottom: 5px;
            font-size: 13px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }
        
        .card-description {
            color: #cbd5e1;
            font-size: 11px;
            line-height: 1.3;
        }
        
        .card-item {
            border-left: 4px solid #10b981;
        }
        
        .card-item::before {
            background: linear-gradient(90deg, #10b981, #059669);
        }
        
        .card-item .card-name {
            color: #6ee7b7;
        }
        
        .card-event {
            border-left: 4px solid #f59e0b;
        }
        
        .card-event::before {
            background: linear-gradient(90deg, #f59e0b, #d97706);
        }
        
        .card-event .card-name {
            color: #fbbf24;
        }
        
        .card-anomaly {
            border-left: 4px solid #ef4444;
        }
        
        .card-anomaly::before {
            background: linear-gradient(90deg, #ef4444, #dc2626);
        }
        
        .card-anomaly .card-name {
            color: #fca5a5;
        }
        
        /* Game Log */
        .game-log {
            background: 
                linear-gradient(135deg, rgba(0, 0, 0, 0.4), rgba(20, 20, 40, 0.3));
            border-radius: 10px;
            padding: 15px;
            max-height: 350px;
            max-width: 100%;
            overflow-y: auto;
            overflow-x: hidden;
            font-size: 12px;
            line-height: 1.4;
            border: 1px solid rgba(79, 209, 199, 0.2);
            box-shadow: 
                inset 0 1px 2px rgba(255, 255, 255, 0.05),
                0 4px 12px rgba(0, 0, 0, 0.3);
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        .game-log::-webkit-scrollbar {
            width: 6px;
        }
        
        .game-log::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 3px;
        }
        
        .game-log::-webkit-scrollbar-thumb {
            background: rgba(79, 209, 199, 0.5);
            border-radius: 3px;
        }
        
        .game-log::-webkit-scrollbar-thumb:hover {
            background: rgba(79, 209, 199, 0.7);
        }
        
        .log-entry {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 6px;
            border-left: 4px solid #4fd1c7;
            background: 
                linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.03));
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            opacity: 0;
            animation: fadeInUp 0.4s ease forwards;
            max-width: 100%;
            overflow: hidden;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
        }
        
        .log-entry:hover {
            background: 
                linear-gradient(135deg, rgba(255, 255, 255, 0.12), rgba(255, 255, 255, 0.06));
        }
        
        .log-timestamp {
            color: #94a3b8;
            font-size: 10px;
            font-family: 'Courier New', monospace;
        }
        
        .log-message {
            color: #e2e8f0;
            margin-top: 3px;
            font-weight: 500;
            max-width: 100%;
            word-break: break-word;
            overflow-wrap: anywhere;
            white-space: pre-wrap;
            line-height: 1.4;
            /* Handle extremely long unbroken strings */
            text-overflow: ellipsis;
            display: block;
        }
        
        /* Handle long URLs or code snippets in logs */
        .log-message code,
        .log-message pre {
            word-break: break-all;
            overflow-wrap: anywhere;
            white-space: pre-wrap;
            max-width: 100%;
            display: inline-block;
        }
        
        /* Additional constraints for log panel within right panel */
        .right-panel .game-log {
            width: 100%;
            box-sizing: border-box;
            flex-shrink: 1;
            min-height: 200px;
        }
        
        /* Ensure log entries can't expand beyond their container */
        .log-entry * {
            max-width: 100%;
            box-sizing: border-box;
        }
        
        .log-action {
            border-left-color: #10b981;
            background: 
                linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05));
        }
        
        .log-error {
            border-left-color: #ef4444;
            background: 
                linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(239, 68, 68, 0.05));
        }
        
        .log-system {
            border-left-color: #f59e0b;
            background: 
                linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(245, 158, 11, 0.05));
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- Left Panel: Game Controls & Player Status -->
        <div class="left-panel">
            <!-- Connection Status -->
            <div class="panel">
                <h3>Connection</h3>
                <div id="connection-status" class="connection-status disconnected">
                    Disconnected
                </div>
            </div>
            
            <!-- Game Controls -->
            <div class="panel">
                <h3>Game Controls</h3>
                <div class="game-controls" id="game-controls">
                    <div class="input-group">
                        <label for="playerName">Player Name</label>
                        <input type="text" id="playerName" placeholder="Enter your name" value="Player1">
                    </div>
                    
                    <button onclick="createGame()" id="createGameBtn">Create New Game</button>
                    
                    <div class="input-group">
                        <label for="gameId">Game ID</label>
                        <input type="text" id="gameId" placeholder="Enter game ID to join">
                    </div>
                    
                    <button onclick="joinGame()" id="joinGameBtn">Join Game</button>
                    
                    <button onclick="startGame()" id="startGameBtn" style="display: none;">Start Game</button>
                </div>
            </div>
            
            <!-- Player Status -->
            <div class="panel player-status" id="player-status" style="display: none;">
                <div class="player-header">
                    <span id="player-name">Player Name</span>
                    <span id="turn-indicator" style="float: right;">⏳</span>
                </div>
                <div class="player-stats">
                    <div class="stat">
                        <span>Disorder:</span>
                        <span id="disorder-value">0</span>
                    </div>
                    <div class="stat">
                        <span>Floor:</span>
                        <span id="floor-value">2</span>
                    </div>
                    <div class="stat">
                        <span>Position:</span>
                        <span id="position-value">(0,0)</span>
                    </div>
                    <div class="stat">
                        <span>Movement:</span>
                        <span id="movement-value">0/0</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Center Panel: Game Board -->
        <div class="center-panel">
            <div class="panel" style="flex: 1;">
                <h3>Game Board</h3>
                <div class="board-controls">
                    <div class="floor-controls">
                        <button onclick="changeFloor(-1)" id="floorDownBtn" class="floor-btn">⬇️ Floor Down</button>
                        <div class="floor-indicator">
                            <span id="current-floor">Floor 2</span>
                        </div>
                        <button onclick="changeFloor(1)" id="floorUpBtn" class="floor-btn">⬆️ Floor Up</button>
                    </div>
                    
                    <div class="game-info">
                        <div class="info-badge">
                            <span class="info-label">Phase:</span>
                            <span id="game-phase" class="info-value">Waiting</span>
                        </div>
                        <div class="info-badge">
                            <span class="info-label">Round:</span>
                            <span id="game-round" class="info-value">0</span>
                        </div>
                    </div>
                </div>
                <div id="game-board" class="game-board">
                    <div class="board-message">
                        Create or join a game to see the board
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Right Panel: Actions & Game Info -->
        <div class="right-panel">
            <!-- Action Buttons -->
            <div class="panel">
                <h3>Actions</h3>
                <div id="action-buttons" class="action-buttons">
                    <p style="color: #888; text-align: center;">Join a game to see actions</p>
                </div>
            </div>
            
            <!-- Player Hand -->
            <div class="panel">
                <h3>Your Hand (<span id="hand-count">0</span>/7)</h3>
                <div id="player-hand" class="player-hand">
                    <p style="color: #888; text-align: center;">No cards</p>
                </div>
            </div>
            
            <!-- Game Log -->
            <div class="panel" style="flex: 1;">
                <h3>Game Log</h3>
                <div id="game-log" class="game-log">
                    <p style="color: #888;">Waiting for game events...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Game state variables
        let socket = null;
        let gameState = null;
        let currentGameId = null;
        // Note: We track current player through socket.id directly, not this variable
        // let currentPlayerId = null; // Removed - using socket.id directly instead
        let selectedFloor = 2;
        
        // Initialize the game
        function initGame() {
            connectToServer();
        }
        
        // Socket connection management
        function connectToServer() {
            socket = io('http://localhost:5000');
            
            socket.on('connect', function() {
                updateConnectionStatus(true);
                addLog('Connected to NMB Game server', 'system');
            });
            
            socket.on('disconnect', function() {
                updateConnectionStatus(false);
                addLog('Disconnected from server', 'error');
            });
            
            // Game event handlers
            socket.on('connected', function(data) {
                addLog(data.message, 'system');
            });
            
            socket.on('game_created', function(data) {
                addLog(`Game created: ${data.game_id}`, 'action');
                currentGameId = data.game_id;
                document.getElementById('gameId').value = data.game_id;
                document.getElementById('startGameBtn').style.display = 'block';
                updateGameControls('host');
            });
            
            socket.on('game_joined', function(data) {
                addLog(`Joined game: ${data.game_id}`, 'action');
                currentGameId = data.game_id;
                updateGameControls('player');
            });
            
            socket.on('player_joined', function(data) {
                addLog(`${data.player_name} joined the game`, 'system');
            });
            
            socket.on('game_started', function(data) {
                addLog('Game started!', 'action');
                gameState = data.game_state;
                document.getElementById('startGameBtn').style.display = 'none';
                updateGameDisplay();
                updateActionButtons();
            });
            
            socket.on('game_state_update', function(data) {
                gameState = data.game_state;
                if (data.action_result) {
                    addLog(`Action: ${JSON.stringify(data.action_result)}`, 'action');
                }
                updateGameDisplay();
                updateActionButtons();
            });
            
            socket.on('action_result', function(data) {
                if (data.success) {
                    addLog(`Action successful: ${data.message || 'Action completed'}`, 'action');
                } else {
                    addLog(`Action failed: ${data.reason}`, 'error');
                }
            });
            
            socket.on('error', function(data) {
                const errorMessage = data.message || data.reason || 'Unknown server error';
                addLog(`Server Error: ${errorMessage}`, 'error');
                console.error('Socket error:', data);
            });
            
            // Enhanced connection event handlers
            socket.on('connect_error', function(error) {
                console.error('Connection error:', error);
                handleNetworkError(error);
            });
            
            socket.on('disconnect', function(reason) {
                console.log('Disconnected:', reason);
                updateConnectionStatus(false);
                addLog(`Disconnected: ${reason}`, 'warning');
                
                if (reason === 'io server disconnect') {
                    // Server disconnected us, don't try to reconnect automatically
                    addLog('Server disconnected the connection. Please refresh the page.', 'error');
                } else {
                    // Client-side disconnect, try to reconnect
                    addLog('Attempting to reconnect...', 'system');
                }
            });
            
            socket.on('reconnect', function(attemptNumber) {
                console.log('Reconnected after', attemptNumber, 'attempts');
                updateConnectionStatus(true);
                addLog(`Reconnected successfully!`, 'success');
                
                // Re-join game if we were in one
                if (currentGameId) {
                    const playerName = document.getElementById('playerName').value.trim();
                    if (playerName) {
                        socket.emit('join_game', { game_id: currentGameId, player_name: playerName });
                        addLog('Rejoining game...', 'system');
                    }
                }
            });
            
            socket.on('reconnect_error', function(error) {
                console.error('Reconnection failed:', error);
                addLog('Failed to reconnect. Please refresh the page.', 'error');
            });
        }
        
        // UI Update functions
        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connection-status');
            if (connected) {
                statusElement.textContent = 'Connected ✅';
                statusElement.className = 'connection-status connected';
            } else {
                statusElement.textContent = 'Disconnected ❌';
                statusElement.className = 'connection-status disconnected';
            }
        }
        
        function updateGameControls(role) {
            const createBtn = document.getElementById('createGameBtn');
            const joinBtn = document.getElementById('joinGameBtn');
            const startBtn = document.getElementById('startGameBtn');
            
            createBtn.disabled = true;
            joinBtn.disabled = true;
            
            if (role === 'host') {
                startBtn.style.display = 'block';
            }
        }
        
        function updateGameDisplay() {
            if (!gameState) return;
            
            // Update game info
            document.getElementById('game-phase').textContent = gameState.phase;
            document.getElementById('game-round').textContent = gameState.round;
            
            // Find current player
            const currentPlayer = getCurrentPlayer();
            if (currentPlayer) {
                updatePlayerStatus(currentPlayer);
                updatePlayerHand(currentPlayer);
            }
            
            // Update board
            updateGameBoard();
        }
        
        function getCurrentPlayer() {
            if (!gameState || !gameState.players) return null;
            
            // Find the player that matches this client's socket ID
            return gameState.players[socket.id] || null;
        }
        
        function updatePlayerStatus(player) {
            document.getElementById('player-status').style.display = 'block';
            document.getElementById('player-name').textContent = player.name;
            document.getElementById('disorder-value').textContent = player.disorder;
            document.getElementById('floor-value').textContent = player.floor;
            
            // Display both tile and sub-position
            const pos = player.position;
            if (pos.tile_x !== undefined) {
                document.getElementById('position-value').textContent = `T(${pos.tile_x},${pos.tile_y}) S(${pos.sub_x},${pos.sub_y})`;
            } else {
                // Legacy format
                document.getElementById('position-value').textContent = `(${player.position[0]}, ${player.position[1]})`;
            }
            
            const movementUsed = player.movement_used || 0;
            const movementPoints = player.movement_points || 0;
            document.getElementById('movement-value').textContent = `${movementUsed}/${movementPoints}`;
            
            // Update disorder styling
            const disorderStat = document.querySelector('#disorder-value').parentElement;
            if (player.disorder >= 6) {
                disorderStat.classList.add('disorder-high');
            } else {
                disorderStat.classList.remove('disorder-high');
            }
            
            // Update turn indicator
            const isCurrentTurn = gameState.current_player === socket.id;
            const turnIndicator = document.getElementById('turn-indicator');
            turnIndicator.textContent = isCurrentTurn ? '🎯 Your Turn' : '⏳ Waiting';
        }
        
        function updateGameBoard() {
            const boardElement = document.getElementById('game-board');
            const currentFloorData = gameState?.board?.floors?.[selectedFloor];
            
            if (!currentFloorData) {
                boardElement.innerHTML = '<div class="board-message">No tiles on this floor</div>';
                return;
            }
            
            // Create board grid - 16x16 sub-positions (4x4 tiles with 4x4 sub-positions each)
            const gridDiv = document.createElement('div');
            gridDiv.className = 'board-grid';
            
            // Create 16x16 sub-position grid
            for (let abs_y = 0; abs_y < 16; abs_y++) {
                for (let abs_x = 0; abs_x < 16; abs_x++) {
                    const subDiv = document.createElement('div');
                    subDiv.className = 'board-tile';
                    
                    // Calculate which tile this sub-position belongs to
                    const tile_x = Math.floor(abs_x / 4);
                    const tile_y = Math.floor(abs_y / 4);
                    const sub_x = abs_x % 4;
                    const sub_y = abs_y % 4;
                    
                    subDiv.dataset.tileX = tile_x;
                    subDiv.dataset.tileY = tile_y;
                    subDiv.dataset.subX = sub_x;
                    subDiv.dataset.subY = sub_y;
                    subDiv.dataset.absX = abs_x;
                    subDiv.dataset.absY = abs_y;
                    
                    // Add tile boundary styling for edges
                    if (sub_x === 0 || sub_x === 3 || sub_y === 0 || sub_y === 3) {
                        subDiv.classList.add('tile-boundary');
                    }
                    
                    // Check if there's a tile at this position
                    const tileKey = `${tile_x},${tile_y}`;
                    const tileData = currentFloorData[tileKey];
                    
                    if (tileData) {
                        // Check if this sub-position is movable
                        const isMovable = tileData.movable_positions?.some(pos => 
                            pos.x === sub_x && pos.y === sub_y);
                        
                        if (isMovable) {
                            // Add tile styling based on type
                            subDiv.classList.add(`tile-${tileData.tile_type}`);
                        } else {
                            // Non-movable position (wall/blocked)
                            subDiv.classList.add('tile-wall');
                        }
                        
                        if (tileData.is_corrupted) {
                            subDiv.classList.add('tile-corrupted');
                        }
                        
                        // Add players on this sub-position
                        const playersOnSubPos = getPlayersOnSubPosition(tile_x, tile_y, sub_x, sub_y, selectedFloor);
                        playersOnSubPos.forEach((player, index) => {
                            const pawnDiv = document.createElement('div');
                            pawnDiv.className = `player-pawn player-${index + 1}`;
                            pawnDiv.textContent = player.name.charAt(0);
                            pawnDiv.title = player.name;
                            subDiv.appendChild(pawnDiv);
                        });
                        
                        // Add click handler for movement
                        if (isMovable) {
                            subDiv.addEventListener('click', () => handleSubPositionClick(tile_x, tile_y, sub_x, sub_y));
                        }
                    }
                    
                    gridDiv.appendChild(subDiv);
                }
            }
            
            boardElement.innerHTML = '';
            boardElement.appendChild(gridDiv);
        }
        
        function getPlayersOnSubPosition(tile_x, tile_y, sub_x, sub_y, floor) {
            if (!gameState?.players) return [];
            
            return Object.values(gameState.players).filter(player => {
                const pos = player.position;
                return pos.tile_x === tile_x && 
                       pos.tile_y === tile_y &&
                       pos.sub_x === sub_x &&
                       pos.sub_y === sub_y &&
                       player.floor === floor;
            });
        }
        
        function updateActionButtons() {
            const actionsDiv = document.getElementById('action-buttons');
            
            if (!gameState || gameState.state !== 'playing') {
                actionsDiv.innerHTML = '<p style="color: #888; text-align: center;">Game not started</p>';
                return;
            }
            
            const isMyTurn = gameState.current_player === socket.id;
            const currentPlayer = getCurrentPlayer();
            
            if (!isMyTurn) {
                actionsDiv.innerHTML = '<p style="color: #888; text-align: center;">Wait for your turn</p>';
                return;
            }
            
            // Generate action buttons based on current game state
            const actions = [];
            
            if (currentPlayer.movement_points > currentPlayer.movement_used) {
                actions.push({ 
                    name: 'Move', 
                    action: 'move', 
                    class: 'primary',
                    disabled: false 
                });
                
                if (currentPlayer.disorder < 6) {
                    actions.push({ 
                        name: 'Explore', 
                        action: 'explore', 
                        class: 'primary',
                        disabled: false 
                    });
                } else {
                    actions.push({ 
                        name: 'Fall', 
                        action: 'fall', 
                        class: 'danger',
                        disabled: false 
                    });
                }
            }
            
            actions.push({ 
                name: 'Pass', 
                action: 'pass', 
                class: '',
                disabled: false 
            });
            
            actions.push({ 
                name: 'End Turn', 
                action: 'end_turn', 
                class: 'danger',
                disabled: false 
            });
            
            // Render action buttons
            actionsDiv.innerHTML = actions.map(action => `
                <button class="action-btn ${action.class}" 
                        onclick="performAction('${action.action}')" 
                        ${action.disabled ? 'disabled' : ''}>
                    ${action.name}
                </button>
            `).join('');
        }
        
        function updatePlayerHand(player) {
            const handDiv = document.getElementById('player-hand');
            const handCount = document.getElementById('hand-count');
            
            const cards = player.inventory?.hand || [];
            handCount.textContent = cards.length;
            
            if (cards.length === 0) {
                handDiv.innerHTML = '<p style="color: #888; text-align: center;">No cards</p>';
                return;
            }
            
            handDiv.innerHTML = cards.map(card => `
                <div class="card card-${card.effect_type || 'item'}" onclick="useCard('${card.card_id}')">
                    <div class="card-name">${card.name}</div>
                    <div class="card-description">${card.description || 'No description'}</div>
                </div>
            `).join('');
        }
        
        // Game action functions with enhanced validation
        function createGame() {
            const playerName = document.getElementById('playerName').value.trim();
            
            // Validate player name
            const validation = validatePlayerName(playerName);
            if (!validation.valid) {
                addLog(validation.message, 'error');
                return;
            }
            
            // Check connection
            if (!socket || !socket.connected) {
                addLog('Not connected to server. Please wait for connection.', 'error');
                return;
            }
            
            // Disable button to prevent multiple clicks
            const createBtn = document.getElementById('createGameBtn');
            createBtn.disabled = true;
            createBtn.textContent = 'Creating...';
            
            socket.emit('create_game', { player_name: playerName });
            addLog(`Creating game for player: ${playerName}`, 'system');
            
            // Re-enable button after timeout
            setTimeout(() => {
                createBtn.disabled = false;
                createBtn.textContent = 'Create New Game';
            }, 3000);
        }
        
        function joinGame() {
            const playerName = document.getElementById('playerName').value.trim();
            const gameId = document.getElementById('gameId').value.trim().toUpperCase();
            
            // Validate player name
            const nameValidation = validatePlayerName(playerName);
            if (!nameValidation.valid) {
                addLog(nameValidation.message, 'error');
                return;
            }
            
            // Validate game ID
            const gameIdValidation = validateGameId(gameId);
            if (!gameIdValidation.valid) {
                addLog(gameIdValidation.message, 'error');
                return;
            }
            
            // Check connection
            if (!socket || !socket.connected) {
                addLog('Not connected to server. Please wait for connection.', 'error');
                return;
            }
            
            // Disable button to prevent multiple clicks
            const joinBtn = document.getElementById('joinGameBtn');
            joinBtn.disabled = true;
            joinBtn.textContent = 'Joining...';
            
            socket.emit('join_game', { game_id: gameId, player_name: playerName });
            addLog(`Joining game ${gameId} as ${playerName}`, 'system');
            
            // Re-enable button after timeout
            setTimeout(() => {
                joinBtn.disabled = false;
                joinBtn.textContent = 'Join Game';
            }, 3000);
        }
        
        function startGame() {
            if (!currentGameId) {
                addLog('No active game to start', 'error');
                return;
            }
            
            socket.emit('start_game', { game_id: currentGameId });
            addLog('Starting game...', 'system');
        }
        
        function performAction(actionType) {
            console.log(`🔍 DEBUG: performAction called with actionType: ${actionType}`);
            
            // Check connection first
            if (!socket || !socket.connected) {
                addLog('Not connected to server. Please reconnect.', 'error');
                return;
            }
            
            if (!currentGameId || !gameState) {
                addLog('No active game session', 'error');
                console.log('❌ DEBUG: No active game or game state');
                return;
            }
            
            console.log('✅ DEBUG: Game state exists, proceeding...');
            let actionData = {};
            
            // Handle different action types
            if (actionType === 'move') {
                // For now, just use current position + 1 as target (simplified)
                const currentPlayer = getCurrentPlayer();
                const pos = currentPlayer.position;
                
                if (pos.tile_x !== undefined) {
                    // New position format - move within tile or to adjacent tile
                    let newTileX = pos.tile_x;
                    let newSubX = pos.sub_x + 1;
                    
                    // Handle movement across tile boundary
                    if (newSubX > 3) {
                        newTileX = Math.min(pos.tile_x + 1, 3);
                        newSubX = 0;
                    }
                    
                    actionData.target_position = { 
                        tile_x: newTileX,
                        tile_y: pos.tile_y,
                        sub_x: newSubX,
                        sub_y: pos.sub_y,
                        floor: pos.floor || currentPlayer.floor
                    };
                } else {
                    // Legacy format fallback
                    const newX = Math.min(pos[0] + 1, 3);  // Updated to 4x4 range
                    actionData.target_position = { 
                        x: newX, 
                        y: pos[1], 
                        floor: currentPlayer.floor 
                    };
                }
            } else if (actionType === 'explore') {
                // Let the backend determine the best placement position
                // Frontend just sends the explore action without specifying position
                // Backend will find the best adjacent position automatically
                // actionData is already {} so no need to reassign
            }
            
            // Validate action before sending
            const validation = validateAction(actionType, actionData);
            if (!validation.valid) {
                addLog(validation.message, 'warning');
                return;
            }
            
            console.log(`🔍 DEBUG: About to emit action - type: ${actionType}, data:`, actionData);
            
            // Disable action buttons temporarily to prevent spam
            const actionButtons = document.querySelectorAll('.action-btn');
            actionButtons.forEach(btn => {
                btn.disabled = true;
                btn.style.opacity = '0.6';
            });
            
            socket.emit('player_action', {
                action_type: actionType,
                action_data: actionData
            });
            
            console.log('✅ DEBUG: Action emitted successfully');
            addLog(`Performing action: ${actionType}`, 'action');
            
            // Re-enable action buttons after a short delay
            setTimeout(() => {
                actionButtons.forEach(btn => {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                });
            }, 1000);
        }
        
        function handleSubPositionClick(tile_x, tile_y, sub_x, sub_y) {
            if (!gameState || gameState.current_player !== socket.id) {
                return;
            }
            
            const currentPlayer = getCurrentPlayer();
            
            // Check if this is a move action
            if (currentPlayer.movement_points > currentPlayer.movement_used) {
                const actionData = {
                    target_position: { 
                        tile_x: tile_x, 
                        tile_y: tile_y,
                        sub_x: sub_x,
                        sub_y: sub_y,
                        floor: selectedFloor 
                    }
                };
                
                socket.emit('player_action', {
                    action_type: 'move',
                    action_data: actionData
                });
                
                addLog(`Moving to tile (${tile_x},${tile_y}) sub-position (${sub_x},${sub_y})`, 'action');
            }
        }
        
        function useCard(cardId) {
            if (!currentGameId || !gameState) {
                addLog('No active game', 'error');
                return;
            }
            
            socket.emit('player_action', {
                action_type: 'use_item',
                action_data: { item_id: cardId }
            });
            
            addLog(`Using card: ${cardId}`, 'action');
        }
        
        function changeFloor(direction) {
            const newFloor = selectedFloor + direction;
            if (newFloor >= 1 && newFloor <= 5) {
                selectedFloor = newFloor;
                document.getElementById('current-floor').textContent = `Floor ${selectedFloor}`;
                updateGameBoard();
            }
        }
        
        // Enhanced error handling and utility functions
        function addLog(message, type = 'system') {
            const logDiv = document.getElementById('game-log');
            const timestamp = new Date().toLocaleTimeString();
            
            // Truncate extremely long messages to prevent layout issues
            let displayMessage = message;
            if (message.length > 500) {
                displayMessage = message.substring(0, 480) + '... (truncated)';
            }
            
            // Add appropriate icons for different log types
            const icons = {
                'info': 'ℹ️',
                'action': '⚡',
                'error': '❌',
                'system': '🔧',
                'success': '✅',
                'warning': '⚠️'
            };
            
            const icon = icons[type] || 'ℹ️';
            
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            
            // Escape HTML to prevent XSS and layout issues
            const escapedMessage = displayMessage
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
            
            logEntry.innerHTML = `
                <div class="log-timestamp">${icon} ${timestamp}</div>
                <div class="log-message">${escapedMessage}</div>
            `;
            
            // Add title attribute for full message if truncated
            if (message.length > 500) {
                logEntry.title = message;
            }
            
            // Remove old entries if too many
            while (logDiv.children.length > 100) {
                logDiv.removeChild(logDiv.firstChild);
            }
            
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
            
            // Show toast notification for errors and important messages
            if (type === 'error' || type === 'warning') {
                showToast(message, type);
            }
        }
        
        // Toast notification system
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            // Truncate toast messages too
            let displayMessage = message;
            if (message.length > 200) {
                displayMessage = message.substring(0, 180) + '...';
            }
            
            toast.textContent = displayMessage;
            
            // Style the toast
            Object.assign(toast.style, {
                position: 'fixed',
                top: '20px',
                right: '20px',
                padding: '12px 20px',
                borderRadius: '8px',
                color: 'white',
                fontWeight: 'bold',
                zIndex: '1000',
                transform: 'translateX(100%)',
                transition: 'transform 0.3s ease',
                maxWidth: '300px',
                minWidth: '200px',
                wordWrap: 'break-word',
                overflowWrap: 'break-word',
                wordBreak: 'break-word',
                boxSizing: 'border-box'
            });
            
            // Set background based on type
            const backgrounds = {
                'error': 'linear-gradient(135deg, #ef4444, #dc2626)',
                'warning': 'linear-gradient(135deg, #f59e0b, #d97706)',
                'success': 'linear-gradient(135deg, #10b981, #059669)',
                'info': 'linear-gradient(135deg, #3b82f6, #2563eb)'
            };
            
            toast.style.background = backgrounds[type] || backgrounds.info;
            toast.style.boxShadow = '0 8px 20px rgba(0, 0, 0, 0.3)';
            
            document.body.appendChild(toast);
            
            // Animate in
            setTimeout(() => {
                toast.style.transform = 'translateX(0)';
            }, 100);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (toast.parentNode) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, 5000);
        }
        
        // Enhanced input validation
        function validatePlayerName(name) {
            if (!name || name.trim().length === 0) {
                return { valid: false, message: 'Player name cannot be empty' };
            }
            if (name.trim().length < 2) {
                return { valid: false, message: 'Player name must be at least 2 characters' };
            }
            if (name.trim().length > 20) {
                return { valid: false, message: 'Player name must be 20 characters or less' };
            }
            if (!/^[a-zA-Z0-9\s_-]+$/.test(name.trim())) {
                return { valid: false, message: 'Player name can only contain letters, numbers, spaces, hyphens, and underscores' };
            }
            return { valid: true, message: '' };
        }
        
        function validateGameId(gameId) {
            if (!gameId || gameId.trim().length === 0) {
                return { valid: false, message: 'Game ID cannot be empty' };
            }
            if (gameId.trim().length !== 6) {
                return { valid: false, message: 'Game ID must be exactly 6 characters' };
            }
            if (!/^[A-Z0-9]+$/.test(gameId.trim())) {
                return { valid: false, message: 'Game ID can only contain uppercase letters and numbers' };
            }
            return { valid: true, message: '' };
        }
        
        // Network error handling
        function handleNetworkError(error) {
            console.error('Network error:', error);
            addLog('Connection lost. Attempting to reconnect...', 'error');
            showToast('Connection lost. Please check your internet connection.', 'error');
            
            // Update connection status
            const status = document.getElementById('connection-status');
            status.textContent = 'Reconnecting...';
            status.className = 'connection-status disconnected';
            
            // Try to reconnect after a delay
            setTimeout(() => {
                if (socket && !socket.connected) {
                    socket.connect();
                }
            }, 2000);
        }
        
        // Action validation before sending to server
        function validateAction(actionType, actionData) {
            if (!currentGameId || !gameState) {
                return { valid: false, message: 'No active game session' };
            }
            
            const currentPlayer = getCurrentPlayer();
            if (!currentPlayer) {
                return { valid: false, message: 'Player not found in game' };
            }
            
            // Check if it's the player's turn
            if (gameState.current_player !== socket.id) {
                return { valid: false, message: 'It is not your turn' };
            }
            
            // Validate specific actions
            switch (actionType) {
                case 'move':
                    if (!actionData.target_position) {
                        return { valid: false, message: 'Move action requires a target position' };
                    }
                    break;
                    
                case 'explore':
                    if (currentPlayer.movement_points <= 0) {
                        return { valid: false, message: 'No movement points remaining' };
                    }
                    break;
                    
                case 'meet':
                case 'rob':
                    // Check if there are other players in the same position
                    const samePositionPlayers = Object.values(gameState.players).filter(p => 
                        p.id !== currentPlayer.id &&
                        p.position.tile_x === currentPlayer.position.tile_x &&
                        p.position.tile_y === currentPlayer.position.tile_y &&
                        p.position.sub_x === currentPlayer.position.sub_x &&
                        p.position.sub_y === currentPlayer.position.sub_y &&
                        p.position.floor === currentPlayer.position.floor
                    );
                    
                    if (samePositionPlayers.length === 0) {
                        return { valid: false, message: `No other players at your position for ${actionType} action` };
                    }
                    break;
            }
            
            return { valid: true, message: '' };
        }
        
        // Initialize the game when page loads
        window.addEventListener('load', function() {
            initGame();
            addLog('Welcome to NMB Game!', 'system');
            addLog('Create a new game or join an existing one to start playing.', 'system');
        });
    </script>
</body>
</html>